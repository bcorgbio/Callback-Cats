---
title: "Module 6 Project"
author: "Callback Cats"
date: "2022-11-02"
output: html_document
bibliography: BIOL3140.bib
---


# Introduction

<center>
![Forewing and Hindwing of Different Lepidoptera, Image from @patil2017insight ](https://d3i71xaburhd42.cloudfront.net/729040e948cb87d9f90e5573c731964d6b673146/7-Figure9-1.png){width=40%}

# Methods



### Image acquisition

All images of the Lepidoptera were pulled from the Global Biodiversity Information Facility (GBIF), a clearing house of collections and species information. GBIF have created an R package, [rgif](https://www.gbif.org/tool/81747/rgbif), that allows access to GBIFâ€™s application programming interface (API).This packages allows their records to be searchable from the command line.

```{r, message = FALSE}
library(rgbif) 
```

### Digitization

Roughly 200 species of Lepidoptera

### Shape analysis

### Comparative analysis

### Evolutionary rates

### Shifts in evolutionary rates

### Shape evolution correlation

# Results
###Evolutionary Rates
```{r,"Setting up", include=FALSE }
library(tidyverse)
library(Momocs)

f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)

out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
#make a large df with vroom
out.df <- vroom::vroom(f, id = "filename")

#add wing info
out.df <- out.df %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()

#make list
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)

#extract wing info
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))
outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx()
forewings <- outs %>% 
  filter(wing=="forewing")

hindwings <- outs %>% 
  filter(wing=="hindwing")
```

```{r, "Procrustes and perform EFA", include=FALSE}
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()

hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()

#Perform EFA
forewings %>%
  coo_interpolate(fore.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

hindwings %>% 
   coo_interpolate(hind.min) %>% 
   coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 
```

```{r, "Performing PCA", results=FALSE, message=FALSE}
forewing.pca <- forewings %>%
  coo_interpolate(fore.min) %>%
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwing.pca <-hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

```


```{r, "Load tree, drop tips not in PCA data", include=FALSE}
library(ape)

lep.tree <- ape::read.tree("lep_tree2.tre")
lep.tree <- ladderize(lep.tree)
plot(lep.tree,cex=0.1)
lep.tree$tip.label <- gsub("_"," ",lep.tree$tip.label)
basename(names(outs))[1:5]
lep.sp <- read_csv("lep_image_data.csv")
```
```{r, "Fore- and hindwing PC1 and PC2 stored with species information",include=FALSE}
out.data <- tibble(xy.file=basename(names(outs))) %>% 
  mutate(identifier=gsub("XY_|_hindwing|_forewing|.txt","",xy.file)) %>% 
  left_join(lep.sp)
hindwing.pca2 <-  tibble(xy.file=basename(rownames(hindwing.pca$x)),PC1=hindwing.pca$x[,1],PC2=hindwing.pca$x[,2]) %>% 
  left_join(out.data)
forewing.pca2 <-  tibble(xy.file=basename(rownames(forewing.pca$x)),PC1=forewing.pca$x[,1],PC2=forewing.pca$x[,2])%>% 
  left_join(out.data)
```
```{r, include=FALSE}
drops <- lep.tree$tip.label[!lep.tree$tip.label%in%unique(out.data$species)]
lep.tree2 <- drop.tip(lep.tree,drops)

#PC1s
hind.pc1 <- hindwing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull

names(hind.pc1) <-  hindwing.pca2%>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)

fore.pc1 <- forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(PC1)

names(fore.pc1) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)

#PC2s
hind.pc2 <- hindwing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)

names(hind.pc2) <-  hindwing.pca2%>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>%
  summarize(PC2=mean(PC2)) %>% 
  pull(species)

fore.pc2 <- forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)

names(fore.pc2) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
```
Finding evolutionary rates for fore- and hindwing PCs.
```{r, "Find evolutionary rates for fore- and hindwing PCs",message=FALSE,results=FALSE}
library(phytools)
forePC1.BM<-brownie.lite(lep.tree2,fore.pc1*10)
hindPC1.BM<-brownie.lite(lep.tree2,hind.pc1*10)

forePC2.BM<-brownie.lite(lep.tree2,fore.pc2*10)
hindPC2.BM<-brownie.lite(lep.tree2,hind.pc2*10)
```
```{r, "Comparing PC wing evolutionary rates"}
#Compare PC1 wing evolutionary rates
forePC1.BM$sig2.single
hindPC1.BM$sig2.single

#Compare PC2 wing evolutionary rates
forePC2.BM$sig2.single
hindPC2.BM$sig2.single
```
Using the "noncensored test," analysis showed that the rates of wing-shape evolution between the fore- and hindwings were different. In PC1, the difference was 0.003606043 units. In PC2, the difference was 0.016297642 units. 

###Evolutionary Rate Shifts


# Discussion


# Author Contributions

Clare Mungovan: 
Adam Qu: 
Matteo Torquati: 
Julie Vu: 


# References
