---
title: "Module 7 Project"
author: "Callback Cats"
date: "2022-11-20"
output: html_document
bibliography: BIOL3140_mod7.bib
---
# Introduction
The force produced by the contractions of skeletal muscle allows for movement and stabilization of joints, among other functions. Muscle generation of tension, or force, is based on the speed and length of the muscle. In particular, sliding filament theory posits that sarcomeres produce force by forming cross-bridges, protein complexes formed from the binding of overlapping actin and myosin. This means that greater cross-bridge formation leads to greater force production. It can then be inferred that sarcomere maximal isometric force is determined by the amount of actin-myosin overlap, which changes with muscle fiber length and implies an optimal length for maximal force production (Fig. 1). In this project, the force-length relationship is studied using human forearm flexors, with muscle length manipulated by altering elbow angle. We can then investigate the effect of muscle fiber length on force generation, as well as how the FL relationship is impacted by fatigue.

<center>
![**Fig. 1.** The sarcomere force-length relationship. Graph from @libretexts2020muscle.](https://s3-us-west-2.amazonaws.com/courses-images/wp-content/uploads/sites/1940/2017/05/29212852/h-20tension-20relationship.png)
</center>


A previous study (@Sharma2020angles), observed the FL relationship by measuring maximum isometric contraction in the forearm over a range of elbow angles, finding that maximal force production occurred at an intermediate elbow angle of 90°. @Muanjai2020knee examined knee extensor isometric maximal voluntary contractions (MVCs) at various angles before and after eccentric exercise, finding a loss of force after exercise. Though the authors attribute the force decrease to a deficit in excitation-contraction coupling, it is clear that fatigue has an effect on force production.

We seek to construct isometric force-angle curves for forearm flexor MVCs at a number of elbow angles. The angle (θmax) at which non-fatigued (control) maximum isometric force occurs will be compared to the θmax of fatigued MVCs. The data collected here will help us to answer if isometric MVCs from different subjects coalesce around a typical FL relationship, and if θmax differs significantly between control and fatigue FL relationships.


# Methods

#### Setting Up Dataset for Analysis

```{r, message = FALSE}
library(tidyverse)
library(MuMIn)
library(ggplot2)
library(dplyr)
```

Here we are reading in the data and calculating the normalized force data.
```{r, "loading data and creating a data set", echo=TRUE, results=FALSE, message=FALSE}
k <- list.files("./Project 8 Data", full.names = T,pattern = ".csv")
print(k)
k.l <- list()

for(i in k){
  met.dat <- unlist(strsplit(i,"_"))
  sub <- met.dat[2]
  ang <- as.numeric(met.dat[3])
  exp <- gsub("\\..+","",met.dat[4])
  k.l[[i]] <- read_delim(i,delim = " ", col_names = c("Reading","Force","Unit"), id="Experiment",progress = FALSE) %>%select(Force)%>%
    mutate(sub=sub,ang=ang,exp=exp)
}

data <- do.call(rbind, k.l)
data <- data%>%
  group_by(sub,exp,ang)%>%
  summarise(max.force=max(abs(Force), na.rm=TRUE), n=n())

data <- na.omit(data)

data.joined <- data%>%
  group_by(sub,exp)%>%
  summarize(max.f2 = max(max.force))%>%
  left_join(data)%>%
  mutate(norm.force=max.force/max.f2)

data.con <- filter(data.joined,exp=="control")
data.fat <- filter(data.joined,exp=="fatigue")
```

Here we are just separating the normalized force and angle values for the control and fatigue  data respectively. 
```{r, "setting up con and fat datasets", echo=TRUE, results=FALSE, message=FALSE}

ang.con <- data.con$ang
normF.con <- data.con$norm.force

ang.fat <- data.fat$ang
normF.fat <- data.fat$norm.force
```
# Results


## Control Condtions

```{r, "con models", message=FALSE}
poly.m2.con <- lm(normF.con~poly(ang.con,2)) #second order
poly.m3.con <- lm(normF.con~poly(ang.con,3)) #third order
poly.m4.con <- lm(normF.con~poly(ang.con,4)) #fourth order

AICc(poly.m2.con,poly.m3.con,poly.m4.con)
```

#### The fourth order model fits the best to data because it is has the lowest AIC score. 

```{r, "con pred", message=FALSE}

x.pred<- seq(45,157.5,length.out = 1000) #define 1000 angles from our range

normF.pred.con <- predict(poly.m3.con,newdata = data.frame(ang.con=x.pred)) #predict the force using 1000 angles



```

#### Normative Force vs. Angle of Arm for Control Conditions

```{r, "con graphs", echo=TRUE, results=FALSE, message=FALSE}
qplot(ang.con,normF.con)+geom_point(aes(x=x.pred,y=normF.pred.con),col="red")+geom_point(aes(x=x.pred[which.max(normF.pred.con)],y=normF.pred.con[which.max(normF.pred.con)]),size=5,col="blue")

```

#### Theta Max for Control Conditions

```{r, "con theta max", message=FALSE}
x.pred[which.max(normF.pred.con)]  
```

## Fatigue Condtions

```{r, "Fat models", message=FALSE}
poly.m2.fat <- lm(normF.fat~poly(ang.fat,2)) #second order
poly.m3.fat <- lm(normF.fat~poly(ang.fat,3)) #third order
poly.m4.fat <- lm(normF.fat~poly(ang.fat,4)) #fourth order

AICc(poly.m2.fat,poly.m3.fat,poly.m4.fat) 
```

#### The thirds order model fits to the data the best because it is has the lowest AIC score. 

```{r, "Fat pred", message=FALSE}
normF.pred.fat <- predict(poly.m4.fat,newdata = data.frame(ang.fat=x.pred)) #predict the force using 1000 angles

```

#### Normative Force vs. Angle of Arm for Fatigue Conditions

```{r, "Fat graph ", echo=TRUE, results=FALSE, message=FALSE}
qplot(ang.fat,normF.fat)+geom_point(aes(x=x.pred,y=normF.pred.fat),col="red")+geom_point(aes(x=x.pred[which.max(normF.pred.fat)],y=normF.pred.fat[which.max(normF.pred.fat)]),size=5,col="blue")
```

```{r, "Fat theta max",message=FALSE}
x.pred[which.max(normF.pred.fat)]-x.pred[which.max(normF.pred.con)] 
```

#### There is a 15.5 degree shift in theta max.

<br>

#### Normative Force vs. Angle of Arm Grouped by Control and Fatigue Conditions 
```{r, "overlaying graph",echo=TRUE, results=FALSE, message=FALSE}
data.joined%>%
  ggplot(aes(ang,norm.force,col=exp))+geom_point()
```


Here we are calculating the AIC scores and fitting the models. 
```{r, "Calculating AIC", message=FALSE}
AICs <- data.joined%>%
  group_by(sub,exp)%>%
  summarize(
    m2=AICc(lm(norm.force~poly(ang,2))), #second order
    m3=AICc(lm(norm.force~poly(ang,3))), #third order
    m4=AICc(lm(norm.force~poly(ang,4))) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")%>%
  print()

fits <- data.joined%>%
  group_by(sub,exp)%>%
  summarize(
    m2=predict(lm(norm.force~poly(ang,2)),newdata=data.frame(ang=x.pred)), #second order
    m3=predict(lm(norm.force~poly(ang,3)),newdata=data.frame(ang=x.pred)), #third order
    m4=predict(lm(norm.force~poly(ang,4)),newdata=data.frame(ang=x.pred)) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(sub,exp,model)%>%
  summarize(theta_max=x.pred[which.max(value)])%>%
  print()

best.models <- fits%>%
  left_join(AICs)%>%
  group_by(sub,exp)%>%
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()
```

Performing an ANOVA to investigate whether a shift of theta max is different between the control and fatigue experiments.

```{r, "Calculating ANOVA", message=FALSE}
anova(lm(theta_max~exp,best.models))
```

Calculating the mean shift with SEM.

```{r, "Calculating mean shift", message=FALSE}
best.models%>%
  pivot_wider(id_cols=sub,names_from = exp,values_from=theta_max)%>%
  mutate(shift=fatigue-control)%>%
  ungroup()%>%
  summarize(mean.shift=abs(mean(na.rm=TRUE,shift)),se.shift=sd(na.rm=TRUE,shift)/sqrt(length(shift)))

```

#### There is a 8 degree shift in the mean of theta max between the control and fatigue conditions. 

# Discussion

# Author Contributions

# References
